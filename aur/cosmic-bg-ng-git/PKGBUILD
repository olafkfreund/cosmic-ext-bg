# Maintainer: Olaf K. Freund <olaf@olafkfreund.com>
# https://github.com/olafkfreund/cosmic-bg-ng

pkgname=cosmic-bg-ng-git
_pkgname=cosmic-bg-ng
pkgver=1.2.0.r0.g0000000
pkgrel=1
pkgdesc='Next-generation background service for the COSMIC desktop with animated, video, and shader wallpaper support'
arch=('x86_64' 'aarch64')
url='https://github.com/olafkfreund/cosmic-bg-ng'
license=('MPL-2.0')
depends=(
    'wayland'
    'libxkbcommon'
    'gstreamer'
    'gst-plugins-base'
    'gst-plugins-good'
    'gst-plugins-bad'
    'gst-plugins-ugly'
    'gst-libav'
    'libva'
    'vulkan-icd-loader'
)
makedepends=(
    'cargo'
    'git'
    'just'
    'pkg-config'
    'clang'
    'mold'
)
optdepends=(
    'vulkan-driver: GPU shader wallpaper support'
    'cosmic-bg-settings-git: GUI for managing wallpaper settings'
)
provides=("${_pkgname}" 'cosmic-bg')
conflicts=('cosmic-bg' 'cosmic-bg-git')
source=("git+${url}.git")
sha256sums=('SKIP')

pkgver() {
    cd "${_pkgname}"
    git describe --long --tags --abbrev=7 2>/dev/null | sed 's/^v//;s/\([^-]*-g\)/r\1/;s/-/./g' ||
    printf '%s.r%s.g%s' "$(grep '^version' Cargo.toml | head -1 | cut -d'"' -f2)" \
        "$(git rev-list --count HEAD)" "$(git rev-parse --short=7 HEAD)"
}

prepare() {
    cd "${_pkgname}"
    export RUSTUP_TOOLCHAIN=stable
    cargo fetch --locked --target "$(rustc -vV | sed -n 's/host: //p')"
}

build() {
    cd "${_pkgname}"
    export RUSTUP_TOOLCHAIN=stable
    export CARGO_TARGET_DIR=target
    just build-release
    just build-ctl
}

package() {
    cd "${_pkgname}"
    just rootdir="${pkgdir}" prefix=/usr install
    just rootdir="${pkgdir}" prefix=/usr install-ctl
    install -Dm644 LICENSE.md "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"
}
