# cosmic-bg

COSMIC session service which applies backgrounds to displays. A comprehensive Wayland background daemon for the COSMIC Desktop Environment (System76) with support for static, animated, video, and shader-based wallpapers.

## Features

### Static Wallpapers
- Supports common image formats via [image-rs](https://github.com/image-rs/image#supported-image-formats)
- JPEG XL support via jxl-oxide
- 8-bit and 10-bit (HDR) surface rendering
- Colors and gradients for backgrounds
- Per-display background configuration
- Wallpaper slideshows with periodic rotation
- Shared image cache for memory efficiency

### Live Wallpapers
- **Animated Images**: GIF, APNG, and animated WebP with proper frame timing
- **Video Wallpapers**: MP4, WebM with GStreamer backend
  - Hardware-accelerated decoding (VA-API, NVDEC)
  - Loop playback and speed control
  - Audio muting (default)
- **GPU Shaders**: Procedural animations using wgpu
  - Built-in presets: Plasma, Waves, Gradient
  - Custom WGSL shader support
  - FPS limiting for battery savings

### Performance
- Asynchronous image loading (non-blocking I/O)
- Differential config updates (no full rebuild on changes)
- Frame timing synchronized with Wayland frame callbacks
- LRU image cache with configurable size
- Power-aware rendering for battery systems

### Display Features
- HDR/10-bit display detection and rendering
- Output transform handling (90/180/270 degree rotation)
- Fractional scaling support
- Multi-monitor configurations

## Dependencies

### Build Dependencies
Developers should install Rust from https://rustup.rs/.

- just
- cargo / rustc (Rust 1.85+)
- libwayland-dev
- libxkbcommon-dev
- mold
- pkg-config

### Optional Dependencies (for live wallpapers)
- **GStreamer** (for video wallpapers):
  - libgstreamer1.0-dev
  - libgstreamer-plugins-base1.0-dev
  - gstreamer1.0-plugins-good
  - gstreamer1.0-plugins-bad (for hardware acceleration)
- **wgpu** (for shader wallpapers): GPU with Vulkan, Metal, or DX12 support

## Installation

A release build can be generated by running `just`, and then installed with `sudo just install`.

If packaging, use the `rootdir` variable to change the root path, in addition to the prefix: `just rootdir=debian/cosmic-bg prefix=/usr install`.

To reduce compile times across COSMIC applications, either use `sccache`, or set `CARGO_TARGET_DIR` to a shared path and install with `sudo -E just install`.

## Configuration

Configuration is stored via cosmic-config at `com.system76.CosmicBackground` (version 1).

### Static Wallpaper
```ron
(
    output: "all",
    source: Path("/usr/share/backgrounds/cosmic.jpg"),
    scaling_mode: Zoom,
    rotation_frequency: 3600,
)
```

### Animated Image
```ron
(
    output: "all",
    source: Animation(
        path: "/path/to/animation.gif",
        fps_limit: Some(30),
    ),
)
```

### Video Wallpaper
```ron
(
    output: "all",
    source: Video(
        path: "/path/to/video.mp4",
        loop_playback: true,
        mute_audio: true,
        hw_accel: true,
    ),
)
```

### GPU Shader
```ron
(
    output: "all",
    source: Shader(
        preset: Plasma,
        fps_limit: 30,
    ),
)
```

## Debugging

To get debug logs from the service, first kill the `cosmic-bg` process a few times in a row to prevent it from being launched by `cosmic-session`. Then launch it with `just run` to display backtraces and debug logs in the terminal.

```bash
# Enable detailed logging
RUST_LOG=cosmic_bg=debug just run

# Enable trace-level logging for frame timing
RUST_LOG=cosmic_bg=trace just run
```

## Architecture

```
src/
├── main.rs          # Event loop, Wayland handlers, config watching
├── wallpaper.rs     # Wallpaper management and rendering
├── source.rs        # WallpaperSource trait and implementations
├── animated.rs      # Animated image support (GIF, APNG, WebP)
├── video.rs         # Video playback with GStreamer
├── shader.rs        # GPU shader wallpapers with wgpu
├── cache.rs         # Shared LRU image cache
├── loader.rs        # Async image loading
├── scheduler.rs     # Frame timing and scheduling
├── scaler.rs        # Image scaling (Fit, Zoom, Stretch)
├── draw.rs          # Buffer management and HDR rendering
├── colored.rs       # Solid colors and gradients
├── error.rs         # Error types
└── shaders/         # Built-in WGSL shader presets
    ├── plasma.wgsl
    ├── waves.wgsl
    └── gradient.wgsl
```

## License

Licensed under the [Mozilla Public License Version 2.0](https://choosealicense.com/licenses/mpl-2.0).

### Contribution

Any contribution intentionally submitted for inclusion in the work by you shall be licensed under the Mozilla Public License Version 2.0 (MPL-2.0). Each source file should have a SPDX copyright notice at the top of the file:

```
// SPDX-License-Identifier: MPL-2.0
```
